{% extends "base.html" %}

{% block content %}
<div class="main-content">
    {% if selected_ticker %}
        <div class="summary-header">
            <h1>Daily Summary for <span class="ticker-highlight">{{ selected_ticker }}</span></h1>
            <form action="{{ url_for('refresh_ticker', ticker=selected_ticker) }}" method="get" id="refresh-form">
                <button type="submit" class="refresh-btn" id="refresh-button">
                    <span id="refresh-spinner" class="spinner" style="display: none;"></span>
                    <span id="refresh-text">Refresh Now</span>
                </button>
            </form>
        </div>

        {% if processing_job %}
        <div class="card processing-card">
            <div class="card-body">
                <div class="processing-content">
                    <div class="spinner-big"></div>
                    <h2 class="card-title">Processing Summary</h2>
                    <p class="card-text">A new summary for {{ selected_ticker }} is being generated. This page will automatically refresh when it's ready (usually within 1-2 minutes).</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if summaries %}
            {% for summary in summaries %}
            <div class="card summary-card">
                <div class="card-body">
                    <h2 class="card-title">Summary for {{ summary.date }}</h2>
                    <p class="card-text">{{ summary.text | safe }}</p>
                </div>
            </div>
            {% if summary.sources %}
            <div class="card sources-card">
                <div class="card-body">
                    <h3 class="card-title">Sources for Summary on {{ summary.date }}</h3>
                    <ul class="sources-list">
                        {% for source in summary.sources %}
                        <li><a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.title }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        {% elif not processing_job %}
        <div class="card no-summary-card">
            <div class="card-body">
                <h2 class="card-title">No Summary Available</h2>
                <p class="card-text">There is no summary available for {{ selected_ticker }} yet. Click the "Refresh Now" button to generate the first summary.</p>
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="card no-summary-card">
            <div class="card-body">
                <h2 class="card-title">Welcome</h2>
                <p class="card-text">Please add a stock ticker on the left to get started.</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const refreshForm = document.getElementById('refresh-form');
        const refreshButton = document.getElementById('refresh-button');
        const refreshSpinner = document.getElementById('refresh-spinner');
        const refreshText = document.getElementById('refresh-text');

        if (refreshForm) {
            refreshForm.addEventListener('submit', function() {
                refreshText.textContent = 'Requested...';
                refreshSpinner.style.display = 'inline-block';
                refreshButton.disabled = true;
            });
        }

        // This block checks the job status if the page is showing "Processing..."
        const isProcessing = {{ processing_job | tojson }};
        const ticker = '{{ selected_ticker }}';

        if (isProcessing && ticker) {
            const intervalId = setInterval(() => {
                fetch(`/status/${ticker}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            clearInterval(intervalId);
                            // Reload the page to show the new summary
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error checking job status:', error);
                        clearInterval(intervalId);
                    });
            }, 5000); // Check every 5 seconds
        }
    });
</script>

{% endblock %}

